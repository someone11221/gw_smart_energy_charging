# Example Automations for GW Smart Charging v1.6.0
# ===================================================
# Note: V 1.4.0+ integrace sama automaticky volÃ¡ nabÃ­jecÃ­ skripty kaÅ¾dÃ© 2 minuty.
# Tyto automatizace jsou pouze pÅ™Ã­klady pro pokroÄilÃ© pÅ™Ã­pady nebo notifikace.

# NEW: PÅ™Ã­klady pouÅ¾itÃ­ novÃ© sluÅ¾by get_charging_schedule (v1.6.0)
# =================================================================

# 1. Notifikace o plÃ¡nu nabÃ­jenÃ­ ze sÃ­tÄ›
# ---------------------------------------
- alias: "GW Charging: RannÃ­ notifikace o plÃ¡nu grid nabÃ­jenÃ­"
  description: "DennÃ­ pÅ™ehled plÃ¡novanÃ½ch obdobÃ­ nabÃ­jenÃ­ ze sÃ­tÄ›"
  trigger:
    - platform: time
      at: "06:00:00"
  action:
    - service: gw_smart_charging.get_charging_schedule
      response_variable: schedule_data
    - service: notify.mobile_app
      data:
        title: "ğŸ“Š PlÃ¡n nabÃ­jenÃ­ baterie"
        message: >
          Grid nabÃ­jenÃ­: {{ schedule_data.daily_statistics.grid_charging_periods_count }} obdobÃ­
          Celkem: {{ schedule_data.daily_statistics.total_grid_charge_kwh }} kWh
          OdhadovanÃ© nÃ¡klady: {{ schedule_data.daily_statistics.estimated_grid_cost_czk }} KÄ
          {% if schedule_data.grid_charging_periods | length > 0 %}
          PrvnÃ­ nabÃ­jenÃ­: {{ schedule_data.grid_charging_periods[0].start_time }}-{{ schedule_data.grid_charging_periods[0].end_time }}
          Cena: {{ schedule_data.grid_charging_periods[0].avg_price }} KÄ/kWh
          {% endif %}

# 2. Automatizace zaloÅ¾enÃ¡ na pÅ™Ã­Å¡tÃ­m obdobÃ­ nabÃ­jenÃ­
# ----------------------------------------------------
- alias: "GW Charging: PÅ™Ã­prava pÅ™ed nabÃ­jenÃ­m"
  description: "Provede akci 15 minut pÅ™ed plÃ¡novanÃ½m nabÃ­jenÃ­m"
  trigger:
    - platform: time_pattern
      minutes: "/15"
  action:
    - service: gw_smart_charging.get_charging_schedule
      response_variable: schedule_data
    - condition: template
      value_template: >
        {% set next_charge = schedule_data.get('grid_charging_periods', []) | selectattr('start_slot', 'gt', schedule_data.current_status.slot) | list | first %}
        {% if next_charge %}
          {{ (next_charge.start_slot - schedule_data.current_status.slot) == 1 }}
        {% else %}
          false
        {% endif %}
    - service: notify.persistent_notification
      data:
        title: "âš¡ PÅ™ipravuji se na nabÃ­jenÃ­"
        message: "Za 15 minut zaÄne nabÃ­jenÃ­ ze sÃ­tÄ›"

# 3. Kontrola, zda je plÃ¡novÃ¡no vybÃ­jenÃ­ baterie
# -----------------------------------------------
- alias: "GW Charging: Kontrola battery discharge"
  description: "UpozornÄ›nÃ­ kdyÅ¾ je plÃ¡novÃ¡no vybÃ­jenÃ­ baterie v peak hours"
  trigger:
    - platform: time_pattern
      hours: "/1"
  action:
    - service: gw_smart_charging.get_charging_schedule
      response_variable: schedule_data
    - condition: template
      value_template: "{{ schedule_data.daily_statistics.battery_discharge_periods_count > 0 }}"
    - service: logbook.log
      data:
        name: "GW Smart Charging"
        message: >
          PlÃ¡novÃ¡no {{ schedule_data.daily_statistics.battery_discharge_periods_count }} obdobÃ­ vybÃ­jenÃ­ baterie
          Celkem: {{ schedule_data.daily_statistics.total_battery_discharge_kwh }} kWh

# 4. Notifikace o aktivitÄ› systÃ©mu
# ---------------------------------
- alias: "GW Charging: Activity log notification"
  description: "Notifikace pÅ™i zmÄ›nÄ› aktivity systÃ©mu"
  trigger:
    - platform: state
      entity_id: sensor.gw_smart_charging_activity_log
  condition:
    - condition: template
      value_template: "{{ trigger.from_state.state != trigger.to_state.state }}"
  action:
    - service: notify.persistent_notification
      data:
        title: "ğŸ”„ GW Charging - ZmÄ›na aktivity"
        message: >
          NovÃ½ stav: {{ states('sensor.gw_smart_charging_activity_log') }}
          SOC: {{ state_attr('sensor.gw_smart_charging_activity_log', 'current_soc_pct') }}%
          Baterie: {{ state_attr('sensor.gw_smart_charging_activity_log', 'battery_status') }}

# 5. PÅ™ehled nÃ¡sledujÃ­cÃ­ho obdobÃ­ nabÃ­jenÃ­
# -----------------------------------------
- alias: "GW Charging: Info o pÅ™Ã­Å¡tÃ­m nabÃ­jenÃ­"
  description: "ZobrazÃ­ info o pÅ™Ã­Å¡tÃ­m plÃ¡novanÃ©m nabÃ­jenÃ­"
  trigger:
    - platform: state
      entity_id: sensor.gw_smart_charging_next_grid_charge
  condition:
    - condition: template
      value_template: "{{ trigger.to_state.state != 'none' }}"
  action:
    - service: persistent_notification.create
      data:
        title: "âš¡ NaplÃ¡novÃ¡no grid nabÃ­jenÃ­"
        message: >
          ÄŒas: {{ states('sensor.gw_smart_charging_next_grid_charge') }}
          DÃ©lka: {{ state_attr('sensor.gw_smart_charging_next_grid_charge', 'next_duration_minutes') }} min
          PrÅ¯mÄ›rnÃ¡ cena: {{ state_attr('sensor.gw_smart_charging_next_grid_charge', 'next_avg_price') }} KÄ/kWh
          ReÅ¾im: {{ state_attr('sensor.gw_smart_charging_next_grid_charge', 'next_mode') }}

# 6. VyuÅ¾itÃ­ dat sluÅ¾by pro scÃ©nu
# --------------------------------
- alias: "GW Charging: Nastavit scÃ©nu podle plÃ¡nu"
  description: "UpravÃ­ nastavenÃ­ domu podle plÃ¡nu nabÃ­jenÃ­"
  trigger:
    - platform: time_pattern
      minutes: "/15"
  action:
    - service: gw_smart_charging.get_charging_schedule
      response_variable: schedule_data
    - choose:
        - conditions:
            - condition: template
              value_template: "{{ schedule_data.current_status.mode in ['grid_charge_cheap', 'grid_charge_optimal'] }}"
          sequence:
            - service: scene.turn_on
              target:
                entity_id: scene.low_consumption_mode
        - conditions:
            - condition: template
              value_template: "{{ schedule_data.current_status.mode == 'battery_discharge' }}"
          sequence:
            - service: scene.turn_on
              target:
                entity_id: scene.normal_mode

# PÅ®VODNÃ AUTOMATIZACE (z v1.4.0)
# ================================

# 1. Notifikace pÅ™i zmÄ›nÄ› reÅ¾imu nabÃ­jenÃ­
# ----------------------------------------
- alias: "GW Charging: Notifikace pÅ™i zmÄ›nÄ› reÅ¾imu"
  description: "PoÅ¡le notifikaci pÅ™i zmÄ›nÄ› reÅ¾imu nabÃ­jenÃ­"
  trigger:
    - platform: state
      entity_id: sensor.gw_smart_charging_schedule
  condition:
    - condition: template
      value_template: "{{ trigger.from_state.state != trigger.to_state.state }}"
  action:
    - service: notify.mobile_app
      data:
        title: "GW Smart Charging"
        message: >
          ReÅ¾im zmÄ›nÄ›n: {{ trigger.to_state.state }}
          Cena: {{ state_attr('sensor.gw_smart_charging_schedule', 'current_price') }} CZK/kWh
          SOC: {{ state_attr('sensor.gw_smart_charging_schedule', 'current_soc') }}%

# 2. Notifikace pÅ™i zahÃ¡jenÃ­ nabÃ­jenÃ­ z gridu
# -------------------------------------------
- alias: "GW Charging: Notifikace zahÃ¡jenÃ­ grid nabÃ­jenÃ­"
  description: "UpozornÄ›nÃ­ kdyÅ¾ zaÄne nabÃ­jenÃ­ ze sÃ­tÄ›"
  trigger:
    - platform: state
      entity_id: sensor.gw_smart_charging_schedule
      to: "grid_charge_cheap"
    - platform: state
      entity_id: sensor.gw_smart_charging_schedule
      to: "grid_charge_optimal"
    - platform: state
      entity_id: sensor.gw_smart_charging_schedule
      to: "grid_charge_critical"
  action:
    - service: notify.persistent_notification
      data:
        title: "âš¡ Grid nabÃ­jenÃ­ zahÃ¡jeno"
        message: >
          ReÅ¾im: {{ states('sensor.gw_smart_charging_schedule') }}
          Cena: {{ state_attr('sensor.gw_smart_charging_schedule', 'current_price') }} CZK/kWh

# 3. ManuÃ¡lnÃ­ pÅ™epnutÃ­ do reÅ¾imu nabÃ­jenÃ­
# ----------------------------------------
# Pokud chcete manuÃ¡lnÄ› vynutit nabÃ­jenÃ­ mimo plÃ¡n integrace
- alias: "GW Charging: ManuÃ¡lnÃ­ vynucenÃ© nabÃ­jenÃ­"
  description: "ManuÃ¡lnÃ­ tlaÄÃ­tko pro vynucenÃ­ nabÃ­jenÃ­"
  trigger:
    - platform: state
      entity_id: input_boolean.force_charging  # VytvoÅ™te si tento helper
      to: "on"
  action:
    - service: script.turn_on
      target:
        entity_id: script.nabijeni_on
    - delay:
        seconds: 2
    - service: input_boolean.turn_off
      target:
        entity_id: input_boolean.force_charging

# 4. BezpeÄnostnÃ­ automatizace - zastavit nabÃ­jenÃ­ pÅ™i vysokÃ© cenÄ›
# -----------------------------------------------------------------
# ZÃ¡loÅ¾nÃ­ ochrana pokud by integrace selhala
- alias: "GW Charging: Safety - Stop pÅ™i vysokÃ© cenÄ›"
  description: "BezpeÄnostnÃ­ zastavenÃ­ nabÃ­jenÃ­ pokud cena pÅ™ekroÄÃ­ limit"
  trigger:
    - platform: numeric_state
      entity_id: sensor.gw_smart_charging_price
      above: 5.0  # CZK/kWh - nastavte podle potÅ™eby
  condition:
    - condition: state
      entity_id: switch.gw_smart_charging_auto_charging
      state: "on"
  action:
    - service: script.turn_on
      target:
        entity_id: script.nabijeni_off
    - service: notify.persistent_notification
      data:
        title: "âš ï¸ GW Charging: BezpeÄnostnÃ­ zastavenÃ­"
        message: >
          NabÃ­jenÃ­ zastaveno kvÅ¯li vysokÃ© cenÄ›: {{ states('sensor.gw_smart_charging_price') }} CZK/kWh

# 5. DennÃ­ pÅ™ehled plÃ¡nu nabÃ­jenÃ­
# --------------------------------
- alias: "GW Charging: RannÃ­ pÅ™ehled plÃ¡nu"
  description: "DennÃ­ notifikace s pÅ™ehledem plÃ¡nu nabÃ­jenÃ­"
  trigger:
    - platform: time
      at: "06:00:00"
  action:
    - service: notify.mobile_app
      data:
        title: "ğŸ“Š GW Charging - DennÃ­ plÃ¡n"
        message: >
          NabÃ­jecÃ­ch slotÅ¯ dnes: {{ state_attr('sensor.gw_smart_charging_diagnostics', 'charging_slots_today') }}
          DalÅ¡Ã­ nabÃ­jenÃ­: {{ state_attr('sensor.gw_smart_charging_diagnostics', 'next_charge_time') }}
          Cena: {{ state_attr('sensor.gw_smart_charging_diagnostics', 'next_charge_price') }} CZK/kWh
          AktuÃ¡lnÃ­ SOC: {{ states('sensor.battery_state_of_charge') }}%

# 6. Statistika - logovÃ¡nÃ­ reÅ¾imÅ¯
# --------------------------------
- alias: "GW Charging: LogovÃ¡nÃ­ reÅ¾imÅ¯"
  description: "ZaznamenÃ¡vÃ¡ Äas strÃ¡venÃ½ v jednotlivÃ½ch reÅ¾imech"
  trigger:
    - platform: state
      entity_id: sensor.gw_smart_charging_schedule
  action:
    - service: logbook.log
      data:
        name: "GW Smart Charging"
        message: >
          ReÅ¾im zmÄ›nÄ›n na {{ states('sensor.gw_smart_charging_schedule') }}
          (cena: {{ state_attr('sensor.gw_smart_charging_schedule', 'current_price') }} CZK/kWh,
           SOC: {{ state_attr('sensor.gw_smart_charging_schedule', 'current_soc') }}%)

# 7. Disable automatizace pÅ™i ÃºdrÅ¾bÄ›
# -----------------------------------
- alias: "GW Charging: Disable pÅ™i ÃºdrÅ¾bÄ›"
  description: "Vypne automatizaci bÄ›hem ÃºdrÅ¾by"
  trigger:
    - platform: state
      entity_id: input_boolean.battery_maintenance  # VytvoÅ™te si tento helper
      to: "on"
  action:
    - service: script.turn_on
      target:
        entity_id: script.nabijeni_off
    - service: notify.persistent_notification
      data:
        title: "ğŸ”§ GW Charging - ReÅ¾im ÃºdrÅ¾by"
        message: "AutomatickÃ© nabÃ­jenÃ­ vypnuto kvÅ¯li ÃºdrÅ¾bÄ› baterie"

# Re-enable po skonÄenÃ­ ÃºdrÅ¾by
- alias: "GW Charging: Enable po ÃºdrÅ¾bÄ›"
  description: "Zapne automatizaci po ÃºdrÅ¾bÄ›"
  trigger:
    - platform: state
      entity_id: input_boolean.battery_maintenance
      to: "off"
  action:
    - service: notify.persistent_notification
      data:
        title: "âœ… GW Charging - ÃšdrÅ¾ba dokonÄena"
        message: "AutomatickÃ© nabÃ­jenÃ­ obnoveno"
