# Example Automations for GW Smart Charging v1.4.0
# ===================================================
# Note: V 1.4.0 integrace sama automaticky volÃ¡ nabÃ­jecÃ­ skripty kaÅ¾dÃ© 2 minuty.
# Tyto automatizace jsou pouze pÅ™Ã­klady pro pokroÄilÃ© pÅ™Ã­pady nebo notifikace.

# 1. Notifikace pÅ™i zmÄ›nÄ› reÅ¾imu nabÃ­jenÃ­
# ----------------------------------------
- alias: "GW Charging: Notifikace pÅ™i zmÄ›nÄ› reÅ¾imu"
  description: "PoÅ¡le notifikaci pÅ™i zmÄ›nÄ› reÅ¾imu nabÃ­jenÃ­"
  trigger:
    - platform: state
      entity_id: sensor.gw_smart_charging_schedule
  condition:
    - condition: template
      value_template: "{{ trigger.from_state.state != trigger.to_state.state }}"
  action:
    - service: notify.mobile_app
      data:
        title: "GW Smart Charging"
        message: >
          ReÅ¾im zmÄ›nÄ›n: {{ trigger.to_state.state }}
          Cena: {{ state_attr('sensor.gw_smart_charging_schedule', 'current_price') }} CZK/kWh
          SOC: {{ state_attr('sensor.gw_smart_charging_schedule', 'current_soc') }}%

# 2. Notifikace pÅ™i zahÃ¡jenÃ­ nabÃ­jenÃ­ z gridu
# -------------------------------------------
- alias: "GW Charging: Notifikace zahÃ¡jenÃ­ grid nabÃ­jenÃ­"
  description: "UpozornÄ›nÃ­ kdyÅ¾ zaÄne nabÃ­jenÃ­ ze sÃ­tÄ›"
  trigger:
    - platform: state
      entity_id: sensor.gw_smart_charging_schedule
      to: "grid_charge_cheap"
    - platform: state
      entity_id: sensor.gw_smart_charging_schedule
      to: "grid_charge_optimal"
    - platform: state
      entity_id: sensor.gw_smart_charging_schedule
      to: "grid_charge_critical"
  action:
    - service: notify.persistent_notification
      data:
        title: "âš¡ Grid nabÃ­jenÃ­ zahÃ¡jeno"
        message: >
          ReÅ¾im: {{ states('sensor.gw_smart_charging_schedule') }}
          Cena: {{ state_attr('sensor.gw_smart_charging_schedule', 'current_price') }} CZK/kWh

# 3. ManuÃ¡lnÃ­ pÅ™epnutÃ­ do reÅ¾imu nabÃ­jenÃ­
# ----------------------------------------
# Pokud chcete manuÃ¡lnÄ› vynutit nabÃ­jenÃ­ mimo plÃ¡n integrace
- alias: "GW Charging: ManuÃ¡lnÃ­ vynucenÃ© nabÃ­jenÃ­"
  description: "ManuÃ¡lnÃ­ tlaÄÃ­tko pro vynucenÃ­ nabÃ­jenÃ­"
  trigger:
    - platform: state
      entity_id: input_boolean.force_charging  # VytvoÅ™te si tento helper
      to: "on"
  action:
    - service: script.turn_on
      target:
        entity_id: script.nabijeni_on
    - delay:
        seconds: 2
    - service: input_boolean.turn_off
      target:
        entity_id: input_boolean.force_charging

# 4. BezpeÄnostnÃ­ automatizace - zastavit nabÃ­jenÃ­ pÅ™i vysokÃ© cenÄ›
# -----------------------------------------------------------------
# ZÃ¡loÅ¾nÃ­ ochrana pokud by integrace selhala
- alias: "GW Charging: Safety - Stop pÅ™i vysokÃ© cenÄ›"
  description: "BezpeÄnostnÃ­ zastavenÃ­ nabÃ­jenÃ­ pokud cena pÅ™ekroÄÃ­ limit"
  trigger:
    - platform: numeric_state
      entity_id: sensor.gw_smart_charging_price
      above: 5.0  # CZK/kWh - nastavte podle potÅ™eby
  condition:
    - condition: state
      entity_id: switch.gw_smart_charging_auto_charging
      state: "on"
  action:
    - service: script.turn_on
      target:
        entity_id: script.nabijeni_off
    - service: notify.persistent_notification
      data:
        title: "âš ï¸ GW Charging: BezpeÄnostnÃ­ zastavenÃ­"
        message: >
          NabÃ­jenÃ­ zastaveno kvÅ¯li vysokÃ© cenÄ›: {{ states('sensor.gw_smart_charging_price') }} CZK/kWh

# 5. DennÃ­ pÅ™ehled plÃ¡nu nabÃ­jenÃ­
# --------------------------------
- alias: "GW Charging: RannÃ­ pÅ™ehled plÃ¡nu"
  description: "DennÃ­ notifikace s pÅ™ehledem plÃ¡nu nabÃ­jenÃ­"
  trigger:
    - platform: time
      at: "06:00:00"
  action:
    - service: notify.mobile_app
      data:
        title: "ğŸ“Š GW Charging - DennÃ­ plÃ¡n"
        message: >
          NabÃ­jecÃ­ch slotÅ¯ dnes: {{ state_attr('sensor.gw_smart_charging_diagnostics', 'charging_slots_today') }}
          DalÅ¡Ã­ nabÃ­jenÃ­: {{ state_attr('sensor.gw_smart_charging_diagnostics', 'next_charge_time') }}
          Cena: {{ state_attr('sensor.gw_smart_charging_diagnostics', 'next_charge_price') }} CZK/kWh
          AktuÃ¡lnÃ­ SOC: {{ states('sensor.battery_state_of_charge') }}%

# 6. Statistika - logovÃ¡nÃ­ reÅ¾imÅ¯
# --------------------------------
- alias: "GW Charging: LogovÃ¡nÃ­ reÅ¾imÅ¯"
  description: "ZaznamenÃ¡vÃ¡ Äas strÃ¡venÃ½ v jednotlivÃ½ch reÅ¾imech"
  trigger:
    - platform: state
      entity_id: sensor.gw_smart_charging_schedule
  action:
    - service: logbook.log
      data:
        name: "GW Smart Charging"
        message: >
          ReÅ¾im zmÄ›nÄ›n na {{ states('sensor.gw_smart_charging_schedule') }}
          (cena: {{ state_attr('sensor.gw_smart_charging_schedule', 'current_price') }} CZK/kWh,
           SOC: {{ state_attr('sensor.gw_smart_charging_schedule', 'current_soc') }}%)

# 7. Disable automatizace pÅ™i ÃºdrÅ¾bÄ›
# -----------------------------------
- alias: "GW Charging: Disable pÅ™i ÃºdrÅ¾bÄ›"
  description: "Vypne automatizaci bÄ›hem ÃºdrÅ¾by"
  trigger:
    - platform: state
      entity_id: input_boolean.battery_maintenance  # VytvoÅ™te si tento helper
      to: "on"
  action:
    - service: script.turn_on
      target:
        entity_id: script.nabijeni_off
    - service: notify.persistent_notification
      data:
        title: "ğŸ”§ GW Charging - ReÅ¾im ÃºdrÅ¾by"
        message: "AutomatickÃ© nabÃ­jenÃ­ vypnuto kvÅ¯li ÃºdrÅ¾bÄ› baterie"

# Re-enable po skonÄenÃ­ ÃºdrÅ¾by
- alias: "GW Charging: Enable po ÃºdrÅ¾bÄ›"
  description: "Zapne automatizaci po ÃºdrÅ¾bÄ›"
  trigger:
    - platform: state
      entity_id: input_boolean.battery_maintenance
      to: "off"
  action:
    - service: notify.persistent_notification
      data:
        title: "âœ… GW Charging - ÃšdrÅ¾ba dokonÄena"
        message: "AutomatickÃ© nabÃ­jenÃ­ obnoveno"
